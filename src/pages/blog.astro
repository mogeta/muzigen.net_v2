---
import Layout from '../layouts/Layout.astro';
import ArticleCard from '../components/ArticleCard.astro';
import type { BlogListItem } from '../types/blog';
import { getFirestore } from 'firebase-admin/firestore';
import { app } from '../firebase/server';

let articles: BlogListItem[] = [];
let error: string | null = null;

try {
  const db = getFirestore(app);
  
  const snapshot = await db.collection('blog_contents')
    .where('publish', '==', true)
    .orderBy('created_date', 'desc')
    .get();
  
  articles = snapshot.docs.map((doc) => {
    const data = doc.data();
    return {
      id: doc.id,
      title: data.title || '',
      description: data.description || '',
      ogp_image: data.ogp_image || '',
      tag: data.tag || '',
      created_date: data.created_date?.toDate?.()?.toISOString() || data.created_date || '',
      update_date: data.update_date?.toDate?.()?.toISOString() || data.update_date || '',
    };
  });
} catch (err) {
  console.error('Failed to fetch articles:', err);
  error = err instanceof Error ? err.message : 'Unknown error occurred';
}
---

<Layout title="muzigen.net">
  <main class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold mb-8 text-center">ブログ記事一覧</h1>
    
    {error ? (
      <div class="text-center text-red-600 bg-red-50 p-6 rounded-lg">
        <h2 class="text-lg font-semibold mb-2">エラーが発生しました</h2>
        <p class="text-sm">記事の取得に失敗しました: {error}</p>
        <p class="text-xs mt-2 text-gray-600">Firebase の設定を確認してください。</p>
      </div>
    ) : articles.length === 0 ? (
      <div class="text-center text-gray-600">
        <p>記事が見つかりませんでした。</p>
      </div>
    ) : (
      <div class="space-y-6">
        {articles.map((article) => (
          <ArticleCard article={article} />
        ))}
      </div>
    )}
  </main>
</Layout>

